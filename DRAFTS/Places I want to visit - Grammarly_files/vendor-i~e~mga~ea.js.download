"use strict";(self.webpackChunk_grammarly_denali_app=self.webpackChunk_grammarly_denali_app||[]).push([[7861],{17329:(e,t,s)=>{s.d(t,{JK:()=>i,aq:()=>n,dQ:()=>r});class n extends Error{constructor(e,t){super(e),this.reason=void 0,this.reason=t,this.name="StorageError","captureStackTrace"in Error?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack}toString(){return`${this.name}: ${this.message}${Boolean(this.reason)?` - ${String(this.reason)}`:""}`}static is(e){return e instanceof n}}function i(e){return t=>new n(e,t)}function r(e){var t;return Boolean(null==(t=function(e){const t=e.reason;return null==t?null:"string"==typeof t?t:"object"==typeof t&&"string"==typeof(null==t?void 0:t.name)?String(t.name):null}(e))?void 0:t.startsWith("QuotaExceeded"))}},82775:(e,t,s)=>{s.d(t,{Hi:()=>R,q3:()=>T,FA:()=>O});var n={};s.r(n),s.d(n,{Direction:()=>r,MaxAgeOrigin:()=>a,OrderBy:()=>o});var i={};s.r(i),s.d(i,{ClientMessage:()=>l,ClientMessageImplementations:()=>S,Direction:()=>p,Entry:()=>m,MaxAgeOrigin:()=>f,Message:()=>C,MessageClear:()=>I,MessageEntries:()=>y,MessageGet:()=>E,MessageSave:()=>v,OrderBy:()=>D,ProtocolMessage:()=>u,ProtocolMessageImplementations:()=>b,Root:()=>_,ServerMessage:()=>g,ServerMessageImplementations:()=>w,interpreter:()=>d.n});var r,a,o,h=s(95934);!function(e){e.Descending="descending",e.Ascending="ascending"}(r||(r={})),function(e){e.Write="write",e.ReadWrite="read-write"}(a||(a={})),function(e){e.CreationTime="creation-time",e.ExpirationTime="expiration-time"}(o||(o={}));var c=s(27234),d=s(38791),l=(0,d.L)((function(e){return(0,c.y$)(u(e),e.struct({}))(e)})),u=(0,d.L)((function(e){return e.struct({id:e.number})})),g=(0,d.L)((function(e){return(0,c.y$)(u(e),e.struct({}))(e)})),_=(0,d.L)((function(e){return C(e)})),p=(0,c.Ds)(r),m=(0,d.L)((function(e){return e.struct({key:e.string,data:e.string})})),f=(0,c.Ds)(a),C=(0,d.L)((function(e){var t;return e.sum("action")(((t={})["storage:get"]=E(e),t["storage:clear"]=I(e),t["storage:save"]=v(e),t["storage:entries"]=y(e),t))})),E=(0,d.L)((function(e){return(0,c.y$)(u(e),g(e),e.intersect(e.partial({maxEntries:e.number}))(e.intersect(e.partial({orderBy:D(e)}))(e.intersect(e.partial({direction:p(e)}))(e.struct({action:e.literal("storage:get"),keyPrefixes:e.readonly(e.array(e.string))})))))(e)})),I=(0,d.L)((function(e){return(0,c.y$)(u(e),g(e),e.struct({action:e.literal("storage:clear"),keyPrefixes:e.readonly(e.array(e.string))}))(e)})),v=(0,d.L)((function(e){return(0,c.y$)(u(e),g(e),e.struct({action:e.literal("storage:save"),key:e.string,data:e.string,maxAgeSeconds:e.number,maxAgeOrigin:f(e)}))(e)})),y=(0,d.L)((function(e){return(0,c.y$)(l(e),u(e),e.struct({action:e.literal("storage:entries"),data:e.readonly(e.array(m(e)))}))(e)})),D=(0,c.Ds)(o),S=(0,d.L)((function(e){var t;return e.sum("action")(((t={})["storage:entries"]=y(e),t))})),b=(0,d.L)((function(e){var t;return e.sum("action")(((t={})["storage:get"]=E(e),t["storage:clear"]=I(e),t["storage:save"]=v(e),t["storage:entries"]=y(e),t))})),w=(0,d.L)((function(e){var t;return e.sum("action")(((t={})["storage:get"]=E(e),t["storage:clear"]=I(e),t["storage:save"]=v(e),t))}));const T=n,O=i;var R,M;(M=R||(R={})).Codec=h.tB(h.NW({action:h.tB(h.eu("storage")),id:h.tB(h.ai)})),M.is=M.Codec.is},13970:(e,t,s)=>{function n(e){return new Blob([e]).size}s.d(t,{d:()=>n})},34455:(e,t,s)=>{s.d(t,{DG:()=>o,V$:()=>c,sV:()=>h});var n=s(1224),i=s(9555),r=s(83404),a=(e,t,s)=>new Promise(((n,i)=>{var r=e=>{try{o(s.next(e))}catch(e){i(e)}},a=e=>{try{o(s.throw(e))}catch(e){i(e)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(r,a);o((s=s.apply(e,t)).next())})),o=(e=>(e[e.DISCONNECTED=0]="DISCONNECTED",e[e.IDLE=1]="IDLE",e[e.CONNECTING=2]="CONNECTING",e[e.INITIALIZING=3]="INITIALIZING",e[e.CONNECTED=4]="CONNECTED",e[e.READY=5]="READY",e[e.WAIT_ACK=6]="WAIT_ACK",e[e.CLOSED=7]="CLOSED",e))(o||{}),h=(e=>(e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.SCHEDULE_RECONNECT=2]="SCHEDULE_RECONNECT",e[e.DISCONNECT=3]="DISCONNECT",e[e.IDLE_DISCONNECT=4]="IDLE_DISCONNECT",e[e.CLOSE=5]="CLOSE",e[e.INITIALIZE=6]="INITIALIZE",e[e.INITIALIZED=7]="INITIALIZED",e[e.SEND=8]="SEND",e[e.ACK=9]="ACK",e[e.RESET=10]="RESET",e))(h||{});class c{constructor(e,t){this._originalUrl=e,this._log=n.Bx.Logging.getLogger("coreclients.remote",n.y7.$.DEBUG),this._msgCount=0,t.onConnecting((()=>this._handleConnecting())).onConnect((e=>this._handleConnect(e))).onDisconnect((e=>(this._msgCount=0,this._handleDisconnect(e)))).onMessage(((e,t)=>{this._msgCount++,this._handleMessage(t)})),this._fsm=new i.Z3("remote",0,7).from(0,1).to(2).on(0).from(2).to(4).on(1).from(4).to(3).on(6).from(3).to(5).on(7).from(4,2,3,5).to(0).on(3).from(4,2,3,5,0).to(7).on(5),this._log.isEnabled(n.y7.$.TRACE)&&this._fsm.verbose(o,h)}getWsUrl(){return this._originalUrl}init(e,t){this._log.debug("init"),this._initHandler=e,this._initFailHandler=t}close(e,t){return this._log.debug(`close(${o[this._fsm.current]})`,{code:e,reason:t}),this._fsm.event(5,{code:e,reason:t}).then((e=>{e&&clearTimeout(this._timeout)}))}isClosed(){return this._fsm.is(7)}_handleConnecting(){return a(this,null,(function*(){this._log.debug("Connecting"),(yield this._fsm.event(0))||this._log.error("Can not enter CONNECTING state",{fsmState:o[this._fsm.current]})}))}_handleConnect(e){return a(this,null,(function*(){this._log.debug("Connected"),(yield this._fsm.event(1,e))?this._conn=e:(this._log.error("Can not enter CONNECTED state",{fsmState:o[this._fsm.current]}),yield e.close({reason:"Can not enter CONNECTED state",code:r.C.WsCodes.NORMAL_CLOSURE}))}))}_handleDisconnect(e){return a(this,null,(function*(){this._log.debug("Disconnected",e.reason),this._disconnectHandler(e);const t=this.isClosed()?n.y7.$.WARN:n.y7.$.ERROR;(yield this._fsm.event(3,e))||this._log.log(t,"Can not enter DISCONNECTED state",{reason:e,fsmState:o[this._fsm.current]})}))}_canSend(){return!this._fsm.is(0,2,7)}}},51920:(e,t,s)=>{s.d(t,{b:()=>b,N:()=>W});var n,i=s(66202),r=s(65390),a=s(46238),o=s(84647),h=s(40086),c=s(1224),d=s(94855),l=s(68801),u=s(24819),g=s(90829),_=s(35616),p=s(30399),m=s(72297),f=s(83442),C=s(83404),E=s(64422),I=s(32112);(e=>{class t{constructor(e){this.id=e}}e.Base=t,e.PatchMessage=class extends t{constructor(e,t,s,n,i,r){super(e),this.id=e,this.cl=t,this.rev=s,this.doc_len=n,this.deltas=i,this.revAfterApply=r,this.op="patch"}},e.VersionMessage=class extends t{constructor(e,t){super(e),this.id=e,this.vsn=t,this.op="vsn"}},e.UpdateDocumentMetadata=class extends t{constructor(e,t,s,n){super(e),this.id=e,this.title=t,this.errors=s,this.extra_params=n,this.op="update_document_metadata"}},e.ProofitOptionsMessage=class extends t{constructor(e){super(e),this.id=e,this.op="proofit_turnaround_options"}},e.ProofitPlaceOrderMessage=class extends t{constructor(e,t,s,n,i,r=!1){super(e),this.id=e,this.turnaround=t,this.clarity=s,this.userInputs=n,this.priceOfferId=i,this.payWithCredits=r,this.op="proofit_create_job"}},e.ProofitPlacePaymentOrderMessage=class extends t{constructor(e,t,s,n,i,r=!1,a,o){super(e),this.id=e,this.turnaround=t,this.clarity=s,this.userInputs=n,this.priceOfferId=i,this.payWithCredits=r,this.nonce=a,this.billingZip=o,this.op="proofit_create_job"}},e.ProofitStatisticsMessage=class extends t{constructor(e){super(e),this.id=e,this.op="proofit_statistics"}},e.TokenResponse=class extends t{constructor(e,t){super(e),this.id=e,this.token=t,this.op="token_response"}}})(n||(n={}));var v,y,D=s(86810);(y=v||(v={})).isChange=function(e){return"change"===e.kind},y.isCmd=function(e){return"cmd"===e.kind},y.isMeta=function(e){return"meta"===e.kind};class S{constructor(e,t,s=[]){this._acceptHandler=e,this._dropHandler=t,this._changes=s,this._staging=!1,this._queuedId=0}pushChanges(e){const t=this.isEmpty||this._staging&&1===this._changes.length?r.none:(0,o.pipe)(this._tail(),r.filter(v.isChange));return(0,o.pipe)(t,r.fold((()=>this._enqueueChanges(E.zV.split(e,5e3))),(t=>{const s=t.change.compose(e),[n,...i]=E.zV.split(s,5e3);if(this._replaceChange(this._changes.length-1,n),n.isEmpty){const e=this._changes.pop();setTimeout((()=>this._acceptHandler(e)),0)}return[t.id].concat(this._enqueueChanges(i))})))}pushMeta(e){const t=this.isEmpty||this._staging&&1===this._changes.length?r.none:(0,o.pipe)(this._tail(),r.filter(v.isMeta));return(0,o.pipe)(t,r.fold((()=>{const t=this._queuedId++;return this._changes.push({kind:"meta",meta:e,id:t}),t}),(t=>(Object.assign(t.meta,e),t.id))))}pushCommand(e){const t=this._queuedId++;return this._changes.push({kind:"cmd",cmd:e,id:t}),t}get isStaging(){return this._staging}get isEmpty(){return 0===this._changes.length}get size(){return this._changes.length}poll(){(0,u.V1)(!this._staging,"Should not be in staging mode");const e=r.fromNullable(this._changes[0]);return(0,o.pipe)(e,r.fold(o.constVoid,(()=>this._staging=!0))),e}pop(){(0,u.V1)(!this._staging,"Should not be in staging mode");const e=r.fromNullable(this._changes.shift());return(0,o.pipe)(e,r.fold(o.constVoid,this._acceptHandler)),e}unstage(){(0,u.V1)(this._staging,"Should be in staging mode"),(0,u.V1)(void 0!==this._changes[0],"Staging change should exist"),this._staging=!1}ack(){this.unstage(),this.pop()}transformChangeAgainstQueue(e){return this._changes.reduce(((e,t,s)=>{if(v.isChange(t)){const{change:n}=t,i=n.transform(e,!1);return this._replaceChange(s,i),e.transform(n)}return e}),e)}drop(e,t){if(!this.isEmpty){const[s,n]=void 0===t?[this._changes,[]]:(0,D.jB)(this._changes,(e=>e.kind===t));this._changes=n,s.length>0&&this._dropHandler({messages:s,reason:e})}}toJSON(){return{changes:this._changes}}_tail(){return r.fromNullable(this._changes[this._changes.length-1])}_enqueueChanges(e){return e.map((e=>{const t=this._queuedId++;return this._changes.push({kind:"change",change:e,id:t}),t}))}_replaceChange(e,t){const s=this._changes[e];(0,u.V1)(v.isChange(s),"queued change should exist"),s.change=t}}var b,w,T=s(34455),O=s(63049),R=s(71301),M=s(98544),N=Object.defineProperty,P=Object.defineProperties,A=Object.getOwnPropertyDescriptors,k=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable,H=(e,t,s)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,q=(e,t,s)=>new Promise(((n,i)=>{var r=e=>{try{o(s.next(e))}catch(e){i(e)}},a=e=>{try{o(s.throw(e))}catch(e){i(e)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(r,a);o((s=s.apply(e,t)).next())}));class W extends T.V${constructor(e,t,s,i=b.Queue.create({}),r=500,a=15e3){super(e,t),this._changesQueue=i,this._sendDelay=r,this._requestTimeout=a,this._nextId=1,this._revision=-1,this._clientId=-1,this._forceSend=!1,this._proofitPlansRequester=new _.Wo(this._requestTimeout,"DOX.ProofitPlans"),this._proofitStatisticsRequester=new _.Wo(this._requestTimeout,"DOX.ProofitStatistics"),this._proofitCreateJobRequester=new _.Wo(this._requestTimeout,"DOX.ProofitCreateJob"),this.getProofitPlans=this._startRequestWatch(this._proofitPlansRequester,this._sendInbandCommand((e=>new n.ProofitOptionsMessage(e)))),this.getProofitStatistics=this._startRequestWatch(this._proofitStatisticsRequester,this._sendInbandCommand((e=>new n.ProofitStatisticsMessage(e)))),this._disconnectHandler=()=>{this._changesQueue.isStaging&&(this._log.warn("Got disconnect while trying send changes"),this._changesQueue.unstage()),[this._proofitCreateJobRequester,this._proofitPlansRequester,this._proofitStatisticsRequester].forEach((e=>e.clear("disconnect")))},this._resolvePendingFlushPromise=e=>(0,o.constVoid)(),this._handler=new b.DefaultHandler(s),this._fsm.from(T.DG.READY).to(T.DG.WAIT_ACK).on(T.sV.SEND).from(T.DG.WAIT_ACK).to(T.DG.READY).on(T.sV.ACK,T.sV.RESET).from(T.DG.WAIT_ACK).to(T.DG.DISCONNECTED).on(T.sV.DISCONNECT).from(T.DG.WAIT_ACK).to(T.DG.CLOSED).on(T.sV.CLOSE).on(T.DG.READY,(e=>this._trySendAfterTimeout())).on(T.DG.CLOSED,(e=>{const t=Boolean(e.args)?e.args:null,s=t?new p.v0({code:t.code,status:M.P.CLOSED_ERROR.status,message:Boolean(t.reason)?t.reason:M.P.CLOSED_ERROR.message}):M.P.CLOSED_ERROR;this._failInit(s),this._changesQueue.drop("close")})).on(T.DG.DISCONNECTED,(()=>{this._changesQueue.drop("disconnect","cmd")})),(0,g.hJ)("doxReset",(e=>{if(void 0===e)throw new Error("provide text!");this._handleResetMessage({op:"reset",id:this._nextId++,doc:(new m.R).insert(e),vsn:this._revision+10,clientId:this._clientId})})),(0,g.hJ)("doxState",this),(0,g.hJ)("closeDoxSocket",((e=1e3,t)=>{this._conn._ws.close(e,t)}))}get _isFirstConnect(){return null!=this._initHandler}static getWsDocumentUrl(e,t){return`${e}${void 0===t?"/documents/ws":`/documents/${t}/ws`}`}_startRequestWatch(e,t){return(0,o.pipe)(t,d.AU((e=>d.kb(e)),(t=>()=>e.watchRequest(t))))}get isInitialRevision(){return 1===this._revision}get fsmState(){return T.DG[this._fsm.current]}placeProofitOrder(e,t){const s=h.c.PlanType[e.turnaround],i=e.tier===h.c.PlanTier.Clarity,a={dialect:r.toUndefined(e.userInputs.dialect),quotationType:r.toUndefined(e.userInputs.quotationType),spaceType:r.toUndefined(e.userInputs.spaceType),noteToEditor:r.toUndefined(e.userInputs.noteToEditor)},{priceOfferId:c,payWithCredits:d}=e,l=(0,o.pipe)(t,r.fold((()=>e=>new n.ProofitPlaceOrderMessage(e,s,i,a,c,d)),(e=>{if(e.kind===f.b.creditCard){const t=e;return e=>new n.ProofitPlacePaymentOrderMessage(e,s,i,a,c,d,t.nonce,t.postalCode)}if(e.kind===f.b.paypal){const t=e;return e=>new n.ProofitPlacePaymentOrderMessage(e,s,i,a,c,d,t.nonce)}return(0,u.xb)(e)})));return this._startRequestWatch(this._proofitCreateJobRequester,this._sendInbandCommand(l))}pushChanges(e){return l.uC((()=>this._pushChanges(e)))}updateMetadata(e){return l.uC((()=>this._updateMetadata(e)))}getWsUrl(){if(-1===this._revision)return this._originalUrl;const e=new URL(this._originalUrl);return e.searchParams.append("sinceVersion",String(this._revision)),e.toString()}_handleMessage(e){return q(this,null,(function*(){try{yield this._messageHandler(e)}catch(e){this._log.warn("Fail on processing incoming message",e),this._failInit(e),this._conn.close({code:C.C.WsCodes.CLIENT_MALFUNCTION,reason:`Unexpected failure on: ${(0,u.Cb)(e)?e.message:""}`})}}))}_messageHandler(e){return q(this,null,(function*(){switch(this._log.isEnabled(c.y7.$.TRACE)&&this._log.trace("Message <<<",{message:JSON.stringify(e)}),e.op){case"init":yield this._handleInitMessage(e);break;case"patch":this._fsm.is(T.DG.READY)||this._fsm.is(T.DG.WAIT_ACK)&&this._clientId===e.cl?yield this._handlePatchMessage(e):this._fsm.is(T.DG.WAIT_ACK)?(this._log.warn("got change while waiting ack for other change"),yield this._handlePatchMessage(e)):this._log.warn("got unexpected patch message",{fsmState:T.DG[this._fsm.current]});break;case"reset":yield this._handleResetMessage(e);break;case"vsn":case"mongodb_change":break;case"document_metadata_changed":this._handleMetaChangeMessage(e);break;case"proofit_turnaround_options":(0,o.pipe)(h.c.processOptions((0,o.unsafeCoerce)(e)),i.fold((t=>this._proofitPlansRequester.onError(e.id,t)),(t=>this._proofitPlansRequester.onValue(e.id,t))));break;case"proofit_create_job":this._proofitCreateJobRequester.onValue(e.id,h.c.parseCreateJobResult(e));break;case"proofit_statistics":this._proofitStatisticsRequester.onValue(e.id,h.c.processStatistics(e));break;case"token_request":yield this._handleUpdateTokenRequest();break;default:e.error||(this._log.warn("Unexpected message",{message:e}),this._failInit(e))}}))}_handleInitMessage(e){return q(this,null,(function*(){if(yield this._fsm.event(T.sV.INITIALIZE)){const t=void 0!==e.deltas?e.deltas:[];if(t.length>0){this._log.debug("Got changes on init. Skipping reset");const s=(0,D.qI)(t.map((e=>e.deltas))),i=t[0].doc_len,r=t[0].rev;yield this._handlePatchMessage(new n.PatchMessage(-1,-1,r,i,s,e.vsn),e.doc_len)}const s=new m.R(e.doc);this._initHandler?(this._log.trace("calling _initHandler"),this._initHandler({initialDelta:E.lY.unsafeRes(s),remoteDocument:this,meta:b.Meta.parse(e)}),this._initHandler=null,this._initFailHandler=null,this._clear(e)):0===t.length&&e.vsn!==this._revision?(this._log.debug("Remote has unknown revision, goto reset"),this._handleResetMessage({id:-1,op:"reset",clientId:e.clientId,vsn:e.vsn,doc:s})):this._clear(e),this._log.trace("Init complete, going to INITIALIZED"),yield this._fsm.event(T.sV.INITIALIZED)}}))}get inSync(){return this._changesQueue.isEmpty&&!this._changesQueue.isStaging}isStable(e){return void 0!==e&&void 0===e.error&&this._msgCount>5}_handlePatchMessage(e,t){return q(this,null,(function*(){const s=e.cl===this._clientId;if(s)this._log.trace("got patch from same client"),(yield this._fsm.event(T.sV.ACK))?(this._log.trace("got ack for patch"),this._changesQueue.ack()):this._log.debug("got patch message from same client, but we are in unexpected state",{state:T.DG[this._fsm.current]});else{this._log.trace("got patch from other client"),(0,u.vA)(this._revision,e.rev,"incoming patch should be on known revision"),this._handler.changeHandler(this,E.lY.flush());const s=I.E.squash(e.deltas),n=E.lY.delta(new m.R(s),e.doc_len);void 0!==t&&(0,u.vA)(t,n.length+n.prevLen,"validated doc_len should match"),this._log.isEnabled(c.y7.$.TRACE)&&!this._changesQueue.isEmpty&&this._log.trace("received incoming change, while has outgoing changes",JSON.stringify(n));const i=this._changesQueue.transformChangeAgainstQueue(n);n.prevLen!==i.prevLen&&(this._log.debug("incoming delta changed prev_len after transform on queue",{was:n.prevLen,now:i.prevLen}),this._log.trace("incoming delta transformed to",i)),this._handler.changeHandler(this,i)}this._revision=s?e.rev:void 0===e.revAfterApply?e.rev+1:e.revAfterApply;try{yield this._conn.send(new n.VersionMessage(this._nextId++,e.rev))}catch(e){this._log.debug("fail onsend vsn ack",e)}}))}_handleResetMessage(e){return q(this,null,(function*(){this._log.warn(`Got RESET message. currently in ${T.DG[this._fsm.current]}`),this._fsm.is(T.DG.READY)||(yield this._fsm.event(T.sV.RESET))?(this._changesQueue.isStaging&&(this._log.debug("We got reset while trying send changed"),this._changesQueue.unstage()),this._changesQueue.drop("got reset"),this._clear(e),this._handler.changeHandler(this,E.lY.unsafeRes(new m.R(e.doc)))):this._log.warn(`Can not enter reset state, currently in ${T.DG[this._fsm.current]}`)}))}_handleMetaChangeMessage(e){this._changesQueue.drop("got incoming meta","meta");const t=b.Meta.parse(e);this._handler.metadataChangeHandler(this,t)}_handleUpdateTokenRequest(){this._log.debug("_handleUpdateTokenRequest");const e=a.of((0,o.constVoid)());return(0,o.pipe)(this._handler.updateTokenHandler,d.cy(r.fold((()=>d.pG("Token is missing")),(e=>(0,o.pipe)(this._sendInbandCommand((t=>new n.TokenResponse(t,e))),d.Tj((()=>"Token updated")))))),d.AU((t=>(this._log.warn("Fail on update token request",t),e)),(t=>(this._log.debug(t),e))))()}_failInit(e){this._initFailHandler&&(this._log.trace(`_failInit(${T.DG[this._fsm.current]})`),this._initFailHandler(e),this._initHandler=null,this._initFailHandler=null)}_clear({vsn:e,clientId:t}){this._log.trace(`_clear: resetting client id ${this._clientId} -> ${t}, revision ${this._revision} -> ${e}`),this._nextId=1,this._clientId=t,this._revision=e}flush(){if(this._log.trace(`flush(${T.DG[this._fsm.current]})`),this._changesQueue.isEmpty)return this._resolvePendingFlushPromise(),Promise.resolve();if(!this._flushPromise){let e;const t=()=>{this._flushPromise=void 0,this._forceSend=!1,this._resolvePendingFlushPromise=o.constVoid,e&&clearTimeout(e)};this._flushPromise=new Promise(((t,s)=>{this._forceSend=!0,this._resolvePendingFlushPromise=t,e=window.setTimeout((()=>s(new _.MU("flush takes too long"))),4e3)})).then(t,(e=>{throw t(),e})),Boolean(this._timeout)&&(clearTimeout(this._timeout),this._timeout=void 0,this._trySendAfterTimeout())}return this._flushPromise}_trySendAfterTimeout(){Boolean(this._timeout)||(this._timeout=window.setTimeout((()=>{this._timeout=void 0,this._fsm.is(T.DG.READY)?this._changesQueue.isEmpty||this._changesQueue.isStaging?(this._changesQueue.isEmpty&&this._resolvePendingFlushPromise(),this._trySendAfterTimeout()):this._send().catch((e=>this._log.warn("unexpected error onsend",e))):this._log.trace("_trySendAfterTimeout: not in READY, stopping send loop")}),this._changesQueue.size>1||this._forceSend?this._changesQueue.isStaging?250:0:this._sendDelay))}_send(){return q(this,null,(function*(){if(yield this._fsm.event(T.sV.SEND)){const e=this._changesQueue.poll();yield(0,o.pipe)(e,r.map((e=>q(this,null,(function*(){const t=v.isChange(e),s=this._createMessage(e);this._log.isEnabled(c.y7.$.TRACE)&&this._log.trace("Message >>>",{message:JSON.stringify(s)});try{yield this._conn.send(s),t||((yield this._fsm.event(T.sV.ACK))?this._changesQueue.ack():this._log.debug("can not do ack for non change msg because we are in unexpected state",{state:T.DG[this._fsm.current]}))}catch(t){this._log.error(`Got error on ws send: ${JSON.stringify({error:t,connectionState:this._conn.state,fsmState:T.DG[this._fsm.current],queueSize:this._changesQueue.size,messageKind:e.kind},void 0,2)}`)}})))),r.getOrElse((()=>Promise.resolve())))}else this._log.warn("we can not send")}))}_updateMetadata(e){return this._log.trace("_updateMetadata"),this._canSend()?i.right(this._changesQueue.pushMeta(e)):(this._log.debug("updateMetadata: cannot send, rejecting changes"),this._isFirstConnect?i.left({error:new _.Xb("Cannot send commands as WS connection is down"),queueId:r.none}):i.left({error:new _.Xb("Cannot send commands as WS connection is down"),queueId:r.some(this._changesQueue.pushMeta(e))}))}_pushChanges(e){return this._log.trace(`pushChanges: ${e.kind}`),E.lY.isDelta(e)?this._canSend()?i.right(this._changesQueue.pushChanges(e)):(this._log.debug("pushChanges: cannot send, rejecting changes"),this._isFirstConnect?i.left({error:new _.Xb("Cannot send commands as WS connection is down"),queueIds:r.none}):i.left({error:new _.Xb("Cannot send commands as WS connection is down"),queueIds:r.some(this._changesQueue.pushChanges(e))})):E.lY.isReset(e)?i.left({error:new Error("Invalid change. Reset changes are not supported by dox"),queueIds:r.none}):i.right([])}_sendInbandCommand(e){return d.oF((()=>{const t=e(this._nextId++);if(this._log.trace("_sendInbandCommand:",t.op),!this._canSend())return this._log.warn("_sendInbandCommand: cannot send, rejecting command",t.op),i.left(new _.Xb("Cannot send commands as WS connection is down"));const s=this._changesQueue.isEmpty;return this._changesQueue.pushCommand(t),s&&this._fsm.is(T.DG.READY)&&(this._log.trace("Q.isEmpty, sending command immidiately",t),this._send()),i.right(t.id)}))}_createMessage(e){switch(e.kind){case"change":return this._createPatchMessage(e.change);case"meta":return this._createUpdateMetaMessage(e.meta);case"cmd":return e.cmd;default:return(0,u.xb)(e)}}_createPatchMessage(e){return new n.PatchMessage(this._nextId++,this._clientId,this._revision,e.prevLen,[e.delta])}_createUpdateMetaMessage({title:e,errors:t,settings:s}){return new n.UpdateDocumentMetadata(this._nextId++,e,t,void 0!==s?s.toJSON():void 0)}}((w=b||(b={})).Meta||(w.Meta={})).parse=function(e){const{title:t,errors:s,extra_params:n,proofit:r}=e,a={title:t,errors:s,settings:O.O.Holder.fromJSON(n),proofit:h.c.fromRaw(r)};return"init"===e.op?(c=((e,t)=>{for(var s in t||(t={}))x.call(t,s)&&H(e,s,t[s]);if(k)for(var s of k(t))L.call(t,s)&&H(e,s,t[s]);return e})({},a),d={isDemoDocument:Boolean(e.demo),createdAt:(0,o.pipe)(R.Yr.parseDate(e.created_at),i.getOrElse((()=>null))),originalFilename:e.orig_filename},P(c,A(d))):a;var c,d},w.DefaultHandler=class{constructor(e){this._handler=e,this.changeHandler=this._handler.changeHandler||o.constVoid,this.metadataChangeHandler=this._handler.metadataChangeHandler||o.constVoid,this.connectHandler=this._handler.connectHandler||o.constVoid,this.disconnectHandler=this._handler.disconnectHandler||o.constVoid,this.updateTokenHandler=this._handler.updateTokenHandler||d.pG(r.none)}},(e=>{class t{constructor(e){this._handler=e,this.acceptedMsgHandler=this._handler.acceptedMsgHandler||(()=>{}),this.droppedMsgsHandler=this._handler.droppedMsgsHandler||(()=>{})}}e.DefaultHandler=t,e.create=e=>{const{acceptedMsgHandler:s,droppedMsgsHandler:n}=new t(e);return new S(s,n)}})(w.Queue||(w.Queue={}))},98544:(e,t,s)=>{s.d(t,{P:()=>n});var n,i=s(30399),r=s(83404);(e=>{e.CLOSED_ERROR=new i.v0({status:"closed",message:"client was closed from client side"});class t extends i.v0{constructor(e,t="disconnected",s="Cannot connect to DOX",n){super({status:t,message:s,code:e,url:n}),this.name="WSDisconnectedOnInitError"}}e.WSDisconnectedOnInitError=t;class s extends i.v0{constructor(e="too_big",t="Message is too big, server rejected it",s){super({status:e,message:t,code:r.C.WsCodes.TOO_BIG,url:s}),this.name="WSMessageIsTooBigError"}}e.WSMessageIsTooBigError=s;class n extends i.v0{constructor(e,t,s,n="Disconnected after multiple retries",i){super({status:s,message:n,code:t,url:i}),this.retriesMade=e}}e.WSDisconnectedAfterMultipleRetries=n;class a extends i.v0{constructor(e){super({code:r.C.WsCodes.GOING_AWAY,status:"closed",message:"timeout",url:e})}}e.WSGoingAway=a;class o extends i.v0{constructor(e,t){super({status:"closed",message:t,code:e}),this.name="WSNotRetryableError"}}e.WSNotRetryableError=o})(n||(n={}))}}]);